"""
Test bench for a limited PID controller connected to a plant model with step input.

This test component connects a limited PID controller to a plant model and applies a step input as
setpoint and a constant feedforward signal. The PID controller includes derivative, integral, and
proportional actions with anti-windup and output limitations. The system response can be observed
through the plant output and controller signals.
"""
test component LimPIDTest
  "Limited PID controller with configurable parameters"
  pid = LimPID(Td = 0.1, Ti = 0.5, y_max = 1, y_min = -1, wp = 1, wd = 0, Nd = 10, Ni = 0.9, k_ff = 1) {^pid}
  "Plant model to be controlled"
  plant = Plant() {^plant}
  "Step input signal used as setpoint for the controller"
  signal = Step(height = 1) {^signal}
  "Constant signal for feedforward control"
  signal_ff = Constant(k = 1) {^signal_ff}
relations
  "Initial condition for the first state of the plant"
  initial plant.x1 = 0
  "Initial condition for the plant output"
  initial plant.y = 0
  "Connect step signal to controller setpoint input"
  connect(signal.y, pid.u_s) {^id5}
  "Connect plant output to controller measurement input"
  connect(plant.y, pid.u_m) {^id6}
  "Connect controller output to plant input"
  connect(pid.y, plant.u) {^id7}
  "Connect feedforward signal to controller feedforward input"
  connect(pid.u_ff, signal_ff.y) {^id8}
metadata {
  "Dyad": {"tests": {"case1": {"stop": 10, "expect": {"signals": ["plant.y", "pid.y"]}}}},
  "_links": {
    "pid": {
      "Dyad": {
        "placement": {
          "diagram": {"iconName": "default", "x1": 340, "y1": 60, "x2": 440, "y2": 160, "rot": 0}
        }
      }
    },
    "plant": {
      "Dyad": {
        "placement": {
          "diagram": {"iconName": "default", "x1": 50, "y1": 170, "x2": 150, "y2": 270, "rot": 0}
        }
      }
    },
    "signal": {
      "Dyad": {
        "placement": {
          "diagram": {"iconName": "default", "x1": 40, "y1": 10, "x2": 140, "y2": 110, "rot": 0}
        }
      }
    },
    "signal_ff": {
      "Dyad": {
        "placement": {
          "diagram": {"iconName": "default", "x1": 50, "y1": 340, "x2": 150, "y2": 440, "rot": 0}
        }
      }
    },
    "id5": {
      "Dyad": {
        "edges": [{"S": 1, "M": [{"x": 280, "y": 60}, {"x": 280, "y": 87}], "E": 2}],
        "renderStyle": "standard"
      }
    },
    "id6": {
      "Dyad": {
        "edges": [{"S": 1, "M": [{"x": 280, "y": 220}, {"x": 280, "y": 133}], "E": 2}],
        "renderStyle": "standard"
      }
    },
    "id7": {
      "Dyad": {
        "edges": [
          {
            "S": 1,
            "M": [
              {"x": 500, "y": 111},
              {"x": 500, "y": 500},
              {"x": 20, "y": 500},
              {"x": 20, "y": 220}
            ],
            "E": 2
          }
        ],
        "renderStyle": "standard"
      }
    },
    "id8": {
      "Dyad": {
        "edges": [{"S": 1, "M": [{"x": 410, "y": 390}], "E": 2}],
        "renderStyle": "standard"
      }
    }
  }
}
end